<!DOCTYPE html>
<html lang="en">
<head>
        <title>Upgrading from non-RAID to RAID under Fedora CoreÂ 2</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="./theme/css/main.css" />
</head>
<body>

    <div class="navigation pure-menu pure-menu-horizontal">
        <a href="./" class="pure-menu-heading  pure-menu-link">Slacy's Blog</a>
        <ul class="pure-menu-list">
            <li class="pure-menu-item"></li>

        </ul>
    </div>


<div class="page-container">
    <div class="entry-content">
        <div class="post-meta pure-g">
<div class="pure-u-3-4 meta-data">
    <a href="./category/general.html" class="category">General</a><br />

    <a class="author" href="./author/slacy.html">slacy</a>
    &mdash; <abbr title="2005-04-22T07:00:00-07:00">Fri 22 April 2005</abbr>
</div>        </div>
    </div>

    <div class="article-header-container">
        <div class="background-image-container">

            <div class="background-image-small">
                <div class="title-container">
                    <h1>Upgrading from non-<span class="caps">RAID</span> to <span class="caps">RAID</span> under Fedora Core&nbsp;2</h1>
                </div>
            </div>
        </div>
    </div>

    <div class="entry-content">
        <p>This is a quick how-to about what I had to go through to upgrade my
Fedora Core 2 system from a dual-drive non-<span class="caps">RAID</span> configuration into a
dual-drive <span class="caps">RAID1</span> mirrored system. The problem was&nbsp;this:</p>
<p>I had two 60G drives in my system, mounted on &#8220;/&#8221; and &#8220;/music&#8221;. The one
on /music was serving as my backup drive as well, with a nightly rsync
over from important areas. It was at 99% capaciy, so an upgrade was
eminent. I decided that the right strategy, instead of a nightly rsync,
was to use software <span class="caps">RAID1</span>. Read on for the steps it took to get the new
system up and running, and for the important points I learned about
going from non-<span class="caps">RAID</span> to <span class="caps">RAID</span>.  </p>
<h2>Goals</h2>
<p>What I wanted to do was end up with a single &#8220;/&#8221; filesystem<br>
composed of a <span class="caps">RAID1</span> (mirror) of 2x250G drives. My current system was
two<br>
separate 60G&nbsp;drives.</p>
<h2>First, the&nbsp;backup.</h2>
<p>Like all good system maintenence instructions, this is where I tell you<br>
that you should really back things up before you start. But, as you all<br>
know, backing up an entire system (120G at this point) isn&#8217;t realistic.<br>
Just back up the stuff that&nbsp;matters.</p>
<h2>Some important&nbsp;accessories</h2>
<p>Having a <span class="caps">USB</span> drive enclosure is a fairly nice accessory. In my case, I<br>
was going to use it to copy over everything other than my &#8220;/&#8221;<br>
drive, and its convenient because you don&#8217;t have to open up your case
and<br>
power down your system just to copy some files from another&nbsp;drive.</p>
<h2>Some important pieces of&nbsp;software</h2>
<p>In <span class="caps">FC2</span>, hopefully you&#8217;re using &#8220;yum&#8221; to update your system<br>
packages. Use &#8220;yum&#8221; to get the package &#8220;mdadm&#8221; which<br>
contains mdadm and a couple other tools. This is the new preferred way
to<br>
configure <span class="caps">RAID</span> systems. The &#8220;old&#8221; way is raidtools &amp;<br>
raid.conf. mdadm does not use raid.conf, and does not require a<br>
configuration file. Everything that it needs to know is stored in the<br>
superblock of the <span class="caps">RAID</span> partition&nbsp;itself.</p>
<h2>Get down to a single drive&nbsp;system.</h2>
<p>If possible, remove all drives from your system, including the <span class="caps">CD</span>-<span class="caps">ROM</span>,<br>
except for your &#8220;/&#8221; drive. Additionally, put it in a spot that is<br>
<span class="caps">NOT</span> the same as where your <span class="caps">RAID</span> drives are going to go. For example,
you<br>
probably want your <span class="caps">RAID</span> drives to be the <strong>master</strong> drives on your two<br>
<span class="caps">IDE</span> controllers. Thus, your <span class="caps">RAID</span> drives will be /dev/hda and /dev/hdc.
Put<br>
your &#8220;/&#8221; on /dev/hdb or /dev/hdd. Make sure that your bios can<br>
boot from this alternate location, and boot from it just to try things
out.<br>
At this point, your system is ready to accept the new raid drives. Shut<br>
down, install the new drives, and reboot your&nbsp;system.</p>
<p>At this point, you should have a working system with 3 drives, and the 2
<span class="caps">RAID</span> drives in their final destination locations. Good for&nbsp;you.</p>
<h2>Partition the drives&nbsp;identically</h2>
<p>Now that you have a working system with the drives installed, you
should<br>
boot up and partition the drives using fdisk. I decided to partition
them<br>
as&nbsp;such:</p>
<div class="highlight"><pre><span></span>Disk /dev/hda: 251.0 GB, 251000193024 bytes
255 heads, 63 sectors/track, 30515 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes

   Device Boot      Start         End      Blocks   Id  System
/dev/hda1               1         250     2008093+  83  Linux
/dev/hda2             251         500     2008125   82  Linux swap
/dev/hda3             501       30515   241095487+  fd  Linux raid autodetect
</pre></div>


<p>Note very carefully how I have set up the &#8220;Id&#8221; column. Use the<br>
fdisk command &#8220;t : Change a partition&#8217;s system Id&#8221; to set this<br>
value. The <span class="caps">RAID</span> partitions <span class="caps">MUST</span> have the type &#8220;0xfd&#8221; as shown<br>
above. I have partitioned each drive identically, and I plan on hda1
being<br>
&#8220;/boot&#8221; and hdc1 being a backup of /boot. hda2 and hdc2 are both<br>
swap, and hda3 and hdc3 make up the <span class="caps">RAID</span>&nbsp;array.</p>
<h2>Set up your other non-<span class="caps">RAID</span>&nbsp;partitions</h2>
<p>At this point, its prudent to do all the &#8220;other stuff&#8221; thats<br>
necessary to get a working system. This is all non-<span class="caps">RAID</span> specific, but
are<br>&nbsp;necssary.</p>
<h3>Format your swap and /boot partition, and copy files&nbsp;over</h3>
<p>This is fairly straightforward. Choose the partition you want to be
your<br>
/boot partition (can not be <span class="caps">RAID</span>) and run mkfs on it. For&nbsp;example:</p>
<div class="highlight"><pre><span></span># mkfs /dev/hda1
# mkswap /dev/hda2
</pre></div>


<p>Make a mount point (something like /mnt/boot2) and mount the new /boot,<br>
and copy all the files from the old /boot onto the new&nbsp;/boot.</p>
<p><strong>A Note About Copying Files:</strong> For this setup, I used a &#8220;tar-copy&#8221;
which<br>
is something I learned to use ages ago when I was told that &#8220;cp was
very<br>
slow for this sort of operation&#8221; A tar-copy is essentially a command
that<br>
looks like&nbsp;this:</p>
<div class="highlight"><pre><span></span># cd /source/location
# tar cvf - . | (cd /destination/directory ; tar xf - )
</pre></div>


<p>But, it doesn&#8217;t copy pipes or other special files. My advice to you is<br>
to take a good look at the &#8220;cp&#8221; man page, and do a recursive copy of all
the<br>
files instead of using the tar copy. At the very least, make sure you<br>
specify the &#8220;-a&#8221; option, which turns on a few very important&nbsp;flags</p>
<p><strong>Another Note:</strong> You&#8217;ll need to do a fair bit more to your /boot<br>
partition before you can boot from the <span class="caps">RAID</span>. See&nbsp;below</p>
<h3>Install grub in your boot <span class="caps">MBR</span></h3>
<p>This is straightforward. Just&nbsp;run:</p>
<div class="highlight"><pre><span></span># grub-install --root-directory=/mnt/boot2 /dev/hda
</pre></div>


<p>Thats it for that&nbsp;one.</p>
<h2>Use mdadm to create the <span class="caps">RAID</span>&nbsp;array</h2>
<p>Boot up your system, and use mdadm to create the raid array. The
command<br>
line will look something like&nbsp;this:</p>
<div class="highlight"><pre><span></span>mdadm -C --level=raid1 /dev/md0 -n 2 -x 0 /dev/hda3 /dev/hdc3
</pre></div>


<p>This should correctly initalize the raid array. Once you have created<br>
the drive, you can &#8220;Assemble&#8221; it, which essentially means to<br>
&#8220;start running&#8221; the <span class="caps">RAID</span> array. Note that we have not added a<br>
filesystem to this drive yet. To assemble the array,&nbsp;type:</p>
<div class="highlight"><pre><span></span>mdadm -A /dev/md0
</pre></div>


<p>Now, the array has been created, and is assembled. At this point, you<br>
can check that its running, like&nbsp;this:</p>
<div class="highlight"><pre><span></span># mdadm -D /dev/md0
/dev/md0:
        Version : 00.90.01
  Creation Time : Wed Sep  1 19:26:36 2004
     Raid Level : raid1
     Array Size : 241095360 (229.93 GiB 246.88 GB)
    Device Size : 241095360 (229.93 GiB 246.88 GB)
   Raid Devices : 2
  Total Devices : 2
Preferred Minor : 0
    Persistence : Superblock is persistent

    Update Time : Fri Sep  3 11:02:01 2004
          State : clean, no-errors
 Active Devices : 2
Working Devices : 2
 Failed Devices : 0
  Spare Devices : 0


    Number   Major   Minor   RaidDevice State
       0       3        3        0      active sync   /dev/hda3
       1      22        3        1      active sync   /dev/hdc3
           UUID : a450119b:32910153:21807701:cf41ceea
         Events : 0.148714
</pre></div>


<p>Note that since I&#8217;m writing this on my running system, mine is<br>
&#8220;clean, no-errors&#8221; and does not have a line that says<br>
&#8220;reconstructing&#8221; Since a new array needs to be<br>
&#8220;reconstructed&#8221; when its initally built, your new array should say<br>
reconstructing, and have a percent complete. I highly suggest that you
just<br>
wait for the reconstruction process to finish. It will eliminate one<br>
variable from the bootup equation thats coming later. Just let it sit
for a<br>
couple hours, and it&#8217;ll be&nbsp;fine.</p>
<h2>Create the filesystem on /dev/md0, and mount&nbsp;it.</h2>
<p>Now, you need to create the root filesystem. This is easy, just&nbsp;type:</p>
<div class="highlight"><pre><span></span># mkfs.ext3 /dev/md0
</pre></div>


<p>And let it finish. No problem here. Then, you should create a mount<br>
point, and mount up the new&nbsp;filesystem:</p>
<div class="highlight"><pre><span></span># mkdir /mnt/md

# mount /dev/md0 /mnt/md
</pre></div>


<p>If that worked, you now have a <span class="caps">RAID</span> partition where you can copy all
your<br>&nbsp;files.</p>
<h2>Boot to a single-user&nbsp;system</h2>
<p>You <span class="caps">NEVER</span> want to copy your root filesystem while the system is in
multi-user mode! The files will be in the process of being modified, and
all hell could break loose, and you&#8217;ll never be certain that your new
copy is actually valid. So, get this puppy into single user&nbsp;mode:</p>
<div class="highlight"><pre><span></span># init 1
</pre></div>


<h2>Copy all your files from the existing &#8220;/&#8221; onto your new <span class="caps">RAID</span>&nbsp;array</h2>
<p>See my note above about using a tar-copy versus a recursive cp command.
I think the thing you want here is a recursive copy with the &#8220;-a&#8221; and
&#8220;-x&#8221; flags. It is very important that you use the &#8220;-x&#8221; flag so that you
don&#8217;t make a recursive copy of your copy (since your destination,
/mnt/md is included in everything under&nbsp;&#8220;/&#8221;)</p>
<h2>Run&nbsp;mkinitrd</h2>
<p>mkinitrd is the thing that creates the inital <span class="caps">RAM</span> disk that the kernel
uses during bringup. You have to do this so that the new initrd includes
the necessary <span class="caps">RAID</span> drivers. If you don&#8217;t do this, then it won&#8217;t work at
all. Ever. You wil be in great&nbsp;pain</p>
<p>This is the step that I had no idea I needed to do. The key things to<br>
note are that mkinitrd is too smart for its own good, and won&#8217;t create
an initrd that contains <span class="caps">RAID</span> unless a raid device is currently mounted.
So, since your <span class="caps">RAID</span> device is already running and mounted, you&#8217;re good
to&nbsp;go.</p>
<p><strong>Make sure to back up your old initrd before you&nbsp;start!</strong></p>
<p>My /boot partition looked like&nbsp;this:</p>
<div class="highlight"><pre><span></span># ls /boot
boot                initrd-2.6.8-1.521.img      os2_d.b
boot.b              initrd-2.6.8-1.521.img.bak  System.map
chain.b             kernel.h                    System.map-2.6.8-1.521
config-2.6.8-1.521  lost+found                  vmlinuz
grub                module-info                 vmlinuz-2.6.8-1.521
</pre></div>


<p>So, the name of the initrd thats working is <strong>initrd-2.6.8-1.521.img</strong></p>
<div class="highlight"><pre><span></span># mv initrd-2.6.8-1.521.img initrd-2.6.8-1.521.img.bak
# mkinitrd /mnt/boot2/initrd-2.6.8-1.521.img 2.6.8-1.521
</pre></div>


<p>That should create the new file. Since you have kept the name the same,
then you won&#8217;t have to modify your grub setup. Easy&nbsp;squeezie</p>
<h2>Try it&nbsp;out</h2>
<p>Cross all ten fingers and toes, and reboot your system. Make sure to<br>
modify your <span class="caps">BIOS</span> to boot from the first drive (/dev/hda) and if you&#8217;re<br>
daring, you can remove your old &#8220;/&#8221; drive. It should all&nbsp;work</p>
<p>If you have other files on other drives, then when your system comes up,
you can use a <span class="caps">USB</span> enclosure to mount those files, and copy them over.
That should give you a complete copy of your old data!&nbsp;Hooray!</p>
    </div>

    <footer>
        <div class="pure-g post-footer">
            <div class="pure-u-1 pure-u-md-1-2">
                <div class="pure-g poster-info">
                    <div class="pure-u">
                        <a href="./author/slacy.html"><img src="https://slacy.github.io/blog/images/ygg.png" alt=""></a>
                    </div>
                    <div class="pure-u-3-4">
                        <h3 class="author-name"><a href="./author/slacy.html">slacy</a></h3>
                        <p class="author-description">
                                              
                        </p>
                    </div>
                </div>
            </div>



        </div>


    </footer>


</div>



    <footer class="index-footer">

        <a href="./" title="Slacy's Blog">Slacy's Blog</a>

    </footer>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-85612-4', 'auto');
      ga('send', 'pageview');

    </script>
</body>
</html>