<!DOCTYPE html>
<html lang="en">
<head>
        <title>Using mrtg & snmpd to monitor your OpenWRT router’s throughput</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="./theme/css/main.css" />
</head>
<body>

    <div class="navigation pure-menu pure-menu-horizontal">
        <a href="./" class="pure-menu-heading  pure-menu-link">Slacy's Blog</a>
        <ul class="pure-menu-list">
            <li class="pure-menu-item"></li>

        </ul>
    </div>


<div class="page-container">
    <div class="entry-content">
        <div class="post-meta pure-g">
<div class="pure-u-3-4 meta-data">
    <a href="./category/general.html" class="category">General</a><br />

    <a class="author" href="./author/admin.html">admin</a>
    &mdash; <abbr title="2008-01-17T16:40:00-08:00">Thu 17 January 2008</abbr>
</div>        </div>
    </div>

    <div class="article-header-container">
        <div class="background-image-container">

            <div class="background-image-small">
                <div class="title-container">
                    <h1>Using mrtg <span class="amp">&amp;</span> snmpd to monitor your OpenWRT router&#8217;s&nbsp;throughput</h1>
                </div>
            </div>
        </div>
    </div>

    <div class="entry-content">
        <p>I&#8217;ve looked around on the web for a while for easy instructions about
how to setup an mrtg installation to monitor my OpenWRT router&#8217;s
throughput. Here are my easy instructions for getting this setup up and&nbsp;running:</p>
<p>Note: At first, I didn&#8217;t realize that mrtg would run on a remote
machine. I didn&#8217;t try getting mrtg to run locally on the OpenWRT system,
although this is theoretically possible. I use a secondary machine to
pull data from the&nbsp;router.</p>
<p>1. Install smtpd on the OpenWRT router. This is as easy&nbsp;as:</p>
<blockquote>
<p># ipkg install&nbsp;snmpd</p>
</blockquote>
<p>Once the install has completed, you need to start up snmpd. I just did
this by hand, since my router has a pretty good uptime, and I was
messing around. To start it by hand,&nbsp;say:</p>
<blockquote>
<p># /etc/init.d/snmpd&nbsp;start</p>
</blockquote>
<p>If you want it to start automatically, then you should rename
/etc/init.d/snmpd to something like&nbsp;/etc/init.d/S98snmpd.</p>
<p>2. Install mrtg on your linux box. My main webserver is a Fedora box, so
this was as straightforward&nbsp;as:</p>
<blockquote>
<p># yum install&nbsp;mrtg</p>
</blockquote>
<p>3. Configure mrtg using &#8220;cfgmaker&#8221;. mrtg comes with a default config,
but since router setups vary so much, this default config is pretty much
useless. So, I&nbsp;ran:</p>
<blockquote>
<p># cfgmaker &#8212;ifref=name public@192.168.1.1 &gt;&nbsp;/etc/mrtg/mrtg.cfg</p>
</blockquote>
<p>This created a reasonable config file with a bunch of sections (one
section for each interface on the router). It needed a small tweak, and
that was to define the WorkDir directory to the right place for Fedora,
which is /var/www/mrtg. I then uncommented the bulk of the config
sections in the rest of the&nbsp;file.</p>
<p>4. Manually run the mrtg collection scripts to bootstrap the system. You
can skip this step if you want to just wait 5 minutes. I looked in
/etc/cron.d/mrtg and just ran the command there, which&nbsp;was:</p>
<blockquote>
<p><span class="caps">LANG</span>=C LC_ALL=C /usr/bin/mrtg /etc/mrtg/mrtg.cfg &#8212;lock-file
/var/lock/mrtg/mrtg_l &#8212;confcache-file&nbsp;/var/lib/mrtg/mrtg.ok</p>
</blockquote>
<p>I can this a couple of times until no error messages came out (the first
2 times may produce&nbsp;errors).</p>
<p>5. Alias /mrtg to /var/www/mrtg in your apache configuration file. This
was necessary for me because I have a bunch of virtual hosts. People
without virtual hosts can skip this&nbsp;step.</p>
<p>6. Create a simple /var/www/mrtg/index.html that links to the pages
generated my mrtg. There&#8217;s one page per router interface, so I just made
a bunch of hardcoded links. You can look in /var/www/mrtg to see what
the filenames&nbsp;are.</p>
<p>6. Done! Now you can view my router graphs on
<a href="http://slacy.com/mrtg">slacy.com/mrtg</a>. The interesting ones&nbsp;are:</p>
<p><a href="http://slacy.com/mrtg/192.168.1.1_3.html">eth1</a>: Shows all traffic on
my wireless&nbsp;network.  </p>
<p><a href="http://slacy.com/mrtg/192.168.1.1_6.html">vlan1</a>: Shows all traffic on
my external <span class="caps">WAN</span> port (in/out to the &#8216;real&nbsp;world&#8217;)  </p>
<p>Also note that I&#8217;ve configured them all to have logscale on the Y axis,
since my <span class="caps">ADSL</span> line has such a discrepancy between input and output&nbsp;rates.</p>
<p>I haven&#8217;t exactly figured out what the rest of the interfaces are, but I
can tell that vlan0 and vlan1 are inverse of each&nbsp;other.</p>
<p><img alt="" src="http://slacy.com/mrtg/192.168.1.1_6-day.png"></p>
    </div>

    <footer>
        <div class="tags">
            <a href="./tag/adsl.html">ADSL</a>
            <a href="./tag/bandwidth-graph.html">bandwidth graph</a>
            <a href="./tag/fedora.html">fedora</a>
            <a href="./tag/linux.html">linux</a>
            <a href="./tag/mrtg.html">mrtg</a>
            <a href="./tag/openwrt.html">openwrt</a>
            <a href="./tag/router.html">router</a>
            <a href="./tag/snmpd.html">snmpd</a>
        </div>
        <div class="pure-g post-footer">
            <div class="pure-u-1 pure-u-md-1-2">
                <div class="pure-g poster-info">
                    <div class="pure-u-3-4">
                        <h3 class="author-name"><a href="./author/admin.html">admin</a></h3>
                        <p class="author-description">
                          
                        </p>
                    </div>
                </div>
            </div>



        </div>


    </footer>


</div>



    <footer class="index-footer">

        <a href="./" title="Slacy's Blog">Slacy's Blog</a>

    </footer>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-85612-4', 'auto');
      ga('send', 'pageview');

    </script>
</body>
</html>